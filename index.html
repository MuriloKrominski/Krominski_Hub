<!DOCTYPE html>
<html lang="pt-br">
<head>
    <!-- Author: Murilo Krominski - https://murilokrominski.github.io/ -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Krominski Hub - Gerenciador de Tarefas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .task-card, .area-editor-item { transition: transform 0.2s, box-shadow 0.2s; }
        .task-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .modal { transition: opacity 0.3s ease; }
        .force-badge { font-weight: 700; font-size: 0.9rem; padding: 0.25rem 0.6rem; border-radius: 9999px; color: white; }
        .dropdown-content { display: none; }
        .dropdown:hover .dropdown-content { display: block; }
        #app-container, #login-container { display: none; } /* Escondido por padr√£o */
        /* Para esconder o √≠cone de calend√°rio do input date */
        input[type="date"]::-webkit-calendar-picker-indicator { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Tela de Login -->
    <div id="login-container" class="flex flex-col justify-center items-center h-screen text-center p-4">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">Bem-vindo ao Krominski Hub</h1>
        <p class="text-lg text-gray-600 mb-8">Entre com sua conta do Google para sincronizar suas tarefas em todos os dispositivos.</p>
        <button id="login-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-105 flex items-center gap-3">
            <i class="fab fa-google text-xl"></i>
            <span>Entrar com o Google</span>
        </button>
        <button id="anonymous-login-btn" class="mt-4 text-sm text-gray-500 hover:text-gray-700 hover:underline">
            Continuar como convidado para testar
        </button>
    </div>

    <!-- Conte√∫do Principal do App -->
    <div id="app-container" class="flex flex-col md:flex-row h-screen">
        <!-- Barra Lateral de Categorias -->
        <aside class="w-full md:w-64 bg-white border-r border-gray-200 p-4 space-y-2 overflow-y-auto">
            <div id="category-list" class="space-y-1"></div>
        </aside>

        <!-- Conte√∫do Principal de Tarefas -->
        <main class="flex-1 p-4 md:p-6 lg:p-8 overflow-y-auto">
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                <div>
                    <h2 id="main-title" class="text-3xl font-bold text-gray-900">Todas as Tarefas</h2>
                    <p id="current-date" class="text-md text-gray-500"></p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="add-task-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                        + Adicionar Tarefa
                    </button>
                     <div class="relative dropdown">
                        <button id="user-profile-btn" class="flex items-center gap-2">
                           <img id="user-photo" src="" alt="Foto do Usu√°rio" class="w-10 h-10 rounded-full">
                        </button>
                        <div class="dropdown-content absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-20">
                            <div class="px-4 py-3 text-sm text-gray-900">
                                <div>Conectado como</div>
                                <div id="user-name" class="font-medium truncate"></div>
                            </div>
                            <a href="#" id="manage-areas-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-sitemap w-6"></i> Gerenciar √Åreas</a>
                            <a href="#" id="backup-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-download w-6"></i> Fazer Backup (.xlsx)</a>
                            <a href="#" id="restore-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"><i class="fas fa-upload w-6"></i> Restaurar Backup</a>
                            <div class="border-t border-gray-100"></div>
                            <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100"><i class="fas fa-sign-out-alt w-6"></i> Sair</a>
                        </div>
                    </div>
                    <input type="file" id="restore-file-input" class="hidden" accept=".xlsx, .xls">
                </div>
            </header>
            <div id="task-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            <div id="loading-spinner" class="hidden text-center mt-10">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="mt-2 text-gray-600">Carregando...</p>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="areas-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-40 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl p-6 relative max-h-[80vh] flex flex-col">
            <h3 class="text-2xl font-bold mb-4">Gerenciar √Åreas</h3>
            <p class="text-sm text-gray-500 mb-4">Arraste para reordenar. As altera√ß√µes s√£o salvas automaticamente.</p>
            <div id="areas-list-editor" class="space-y-2 overflow-y-auto flex-1"></div>
            <div class="mt-4 pt-4 border-t">
                <button id="add-area-btn" class="w-full bg-blue-100 text-blue-700 font-semibold py-2 px-4 rounded-lg hover:bg-blue-200 transition duration-300">+ Adicionar Nova √Årea</button>
            </div>
             <button id="close-areas-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
    </div>
    <div id="task-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg p-6 relative max-h-[90vh] flex flex-col">
            <h3 id="modal-title" class="text-2xl font-bold mb-4">Nova Tarefa</h3>
            <form id="task-form" class="flex-1 overflow-y-auto pr-2">
                <input type="hidden" id="task-id">
                <div class="mb-4">
                    <label for="task-name" class="block text-sm font-medium text-gray-700 mb-1">Nome da Tarefa</label>
                    <input type="text" id="task-name" class="w-full p-2 border border-gray-300 rounded-md" required>
                </div>

                <div class="mb-4">
                    <label for="task-details" class="block text-sm font-medium text-gray-700 mb-1">Detalhes</label>
                    <textarea id="task-details" rows="3" class="w-full p-2 border border-gray-300 rounded-md"></textarea>
                </div>

                <div class="mb-4">
                    <label for="task-link" class="block text-sm font-medium text-gray-700 mb-1">Link</label>
                    <input type="url" id="task-link" class="w-full p-2 border border-gray-300 rounded-md" placeholder="https://exemplo.com">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-category" class="block text-sm font-medium text-gray-700 mb-1">√Årea/Categoria</label>
                        <select id="task-category" class="w-full p-2 border border-gray-300 rounded-md"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Data de Conclus√£o</label>
                        <div class="flex items-center gap-2">
                            <button type="button" id="date-btn-today" class="flex-1 bg-gray-200 text-gray-700 py-1 px-2 rounded-md text-sm">Hoje</button>
                            <button type="button" id="date-btn-tomorrow" class="flex-1 bg-gray-200 text-gray-700 py-1 px-2 rounded-md text-sm">Amanh√£</button>
                            <label for="task-due-date" class="cursor-pointer p-2 bg-gray-200 rounded-md"><i class="fas fa-calendar-alt"></i></label>
                            <input type="date" id="task-due-date" class="w-0 p-0 border-0">
                            <button type="button" id="repeat-btn" class="p-2 bg-gray-200 rounded-md"><i class="fas fa-redo"></i></button>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-importance" class="block text-sm font-medium text-gray-700 mb-1">Import√¢ncia</label>
                        <select id="task-importance" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="4">‚ù§Ô∏è‚Äçüî• Urgente</option>
                            <option value="3">üíô Importante</option>
                            <option value="2">üíõ Moderada</option>
                            <option value="1">ü©∂ Ponderar</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-effort" class="block text-sm font-medium text-gray-700 mb-1">Esfor√ßo</label>
                        <select id="task-effort" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="4">üåï Baixo</option>
                            <option value="3">üåî M√©dio</option>
                            <option value="2">üåì Alto</option>
                            <option value="1">üåë Muito Alto</option>
                        </select>
                    </div>
                </div>
            </form>
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button" id="cancel-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300 transition duration-300">Cancelar</button>
                <button type="submit" form="task-form" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">Salvar Tarefa</button>
            </div>
            <button id="close-modal-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
    </div>
    <div id="repeat-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-sm p-6">
            <h3 class="text-xl font-bold mb-4">Definir Repeti√ß√£o</h3>
            <div class="space-y-2">
                <select id="repeat-frequency" class="w-full p-2 border border-gray-300 rounded-md">
                    <option value="none">N√£o repetir</option>
                    <option value="daily">Todos os dias</option>
                    <option value="weekly">Todas as semanas</option>
                    <option value="monthly">Todos os meses</option>
                    <option value="yearly">Todos os anos</option>
                </select>
            </div>
            <div class="flex justify-end space-x-3 mt-6">
                <button type="button" id="cancel-repeat-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Cancelar</button>
                <button type="button" id="save-repeat-btn" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar</button>
            </div>
        </div>
    </div>
    <div id="restore-confirm-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
         <!-- Conte√∫do do modal de confirma√ß√£o de restaura√ß√£o -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, onSnapshot, updateDoc, deleteDoc, query, writeBatch, getDocs, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURA√á√ÉO E ESTADO INICIAL ---
        const firebaseConfig = {
          apiKey: "AIzaSyC59KHuHiOKJa4gmbeCiQWJygqqUkkcdyU",
          authDomain: "krominski-hub.firebaseapp.com",
          projectId: "krominski-hub",
          storageBucket: "krominski-hub.firebasestorage.app",
          messagingSenderId: "447462209767",
          appId: "1:447462209767:web:caea1783c6f5fae853ca42",
          measurementId: "G-FZXEW9F9BG"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let unsubscribeTasks = null;
        let unsubscribeCategories = null;
        let currentCategoryFilter = 'all';
        let categories = [];
        let tasks = [];
        let tempRepeatRule = null;
        let tempDueDate = null;

        const importanceMap = { '4': { text: 'Urgente', emoji: '‚ù§Ô∏è‚ÄçÔøΩ', color: 'bg-red-500' }, '3': { text: 'Importante', emoji: 'üíô', color: 'bg-blue-500' }, '2': { text: 'Moderada', emoji: 'üíõ', color: 'bg-yellow-500' }, '1': { text: 'Ponderar', emoji: 'ü©∂', color: 'bg-gray-500' }};
        const effortMap = { '4': { text: 'Baixo', emoji: 'üåï' }, '3': { text: 'M√©dio', emoji: 'üåî' }, '2': { text: 'Alto', emoji: 'üåì' }, '1': { text: 'Muito Alto', emoji: 'üåë' }};
        
        // --- ELEMENTOS DO DOM ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const categoryList = document.getElementById('category-list');
        const taskList = document.getElementById('task-list');
        const mainTitle = document.getElementById('main-title');
        const currentDateEl = document.getElementById('current-date');
        const loadingSpinner = document.getElementById('loading-spinner');
        const taskModal = document.getElementById('task-modal');
        const taskForm = document.getElementById('task-form');
        const taskCategorySelect = document.getElementById('task-category');
        const taskDueDateInput = document.getElementById('task-due-date');
        const areasModal = document.getElementById('areas-modal');
        const areasListEditor = document.getElementById('areas-list-editor');
        const repeatModal = document.getElementById('repeat-modal');
        const userPhoto = document.getElementById('user-photo');
        const userName = document.getElementById('user-name');

        // --- FUN√á√ïES DE DATA E HORA ---
        function getFormattedDate(date) {
            return new Intl.DateTimeFormat('pt-BR', { weekday: 'long', day: 'numeric', month: 'long' }).format(date);
        }

        function toYYYYMMDD(date) {
            return date.toISOString().split('T')[0];
        }

        function getDaysOverdue(dueDate, resetDate) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const startDate = new Date(resetDate || dueDate);
            startDate.setHours(0, 0, 0, 0);
            if (today <= startDate) return 0;
            return Math.floor((today - startDate) / (1000 * 60 * 60 * 24));
        }

        // --- FUN√á√ïES DE RENDERIZA√á√ÉO E UI ---
        function renderAll() {
            renderCategories();
            renderTasks();
            populateCategorySelect();
            renderAreasModal();
        }

        function renderTasks() {
            taskList.innerHTML = '';
            const filteredTasks = (currentCategoryFilter === 'all' 
                ? tasks 
                : tasks.filter(t => t.category === currentCategoryFilter)
            ).filter(task => {
                const isPontual = !task.repeatRule || task.repeatRule.frequency === 'none';
                return !(isPontual && task.completed);
            });
            
            if (filteredTasks.length === 0) {
                taskList.innerHTML = `<p class="text-gray-500 col-span-full text-center">Nenhuma tarefa encontrada.</p>`;
                return;
            }

            filteredTasks.sort((a, b) => (a.dueDate || '9999').localeCompare(b.dueDate || '9999')).sort((a, b) => b.forca - a.forca);

            filteredTasks.forEach(task => {
                const importance = importanceMap[task.importance] || importanceMap['1'];
                const card = document.createElement('div');
                card.className = `task-card bg-white rounded-lg shadow-md p-4 flex flex-col justify-between border-l-4 ${importance.color.replace('bg-', 'border-')}`;
                
                let dateInfo = '';
                if (task.dueDate) {
                    const daysOverdue = getDaysOverdue(task.dueDate, task.overdueResetDate);
                    const dueDate = new Date(task.dueDate + 'T12:00:00Z'); // Use UTC to avoid timezone shifts
                    const formattedDate = new Intl.DateTimeFormat('pt-BR', { day: 'numeric', month: 'short' }).format(dueDate);
                    const isRepeating = task.repeatRule && task.repeatRule.frequency !== 'none';
                    
                    let overdueCounter = '';
                    if (daysOverdue > 0) {
                        overdueCounter = `<span class="ml-2 text-red-500 font-bold">(${daysOverdue}d)</span>
                        <button data-task-id="${task.id}" class="reset-overdue-btn ml-1 text-gray-400 hover:text-blue-500"><i class="fas fa-sync-alt"></i></button>`;
                    }

                    dateInfo = `<div class="text-sm text-gray-700 mt-2 flex items-center">
                        <i class="far fa-calendar-alt mr-2 ${daysOverdue > 0 ? 'text-red-500' : ''}"></i>
                        <span>${formattedDate}${isRepeating ? ' üîÅ' : ''}</span>
                        ${overdueCounter}
                    </div>`;
                }

                let linkInfo = '';
                if (task.link) {
                    linkInfo = `<a href="${task.link}" target="_blank" class="text-blue-500 hover:underline"><i class="fas fa-link"></i></a>`;
                }

                card.innerHTML = `
                    <div>
                        <div class="flex justify-between items-start">
                             <span class="text-xs font-semibold ${importance.color} text-white px-2 py-1 rounded-full">${importance.emoji} ${importance.text}</span>
                             <span class="force-badge ${importance.color}">For√ßa: ${task.forca}</span>
                        </div>
                        <h4 class="font-bold text-lg mt-2 mb-1">${task.name}</h4>
                        ${task.details ? `<p class="text-sm text-gray-600 mb-2">${task.details}</p>` : ''}
                        ${dateInfo}
                    </div>
                    <div class="flex justify-end items-center mt-4 space-x-2">
                        ${linkInfo}
                        <button data-task-id="${task.id}" class="edit-btn text-gray-400 hover:text-blue-600 transition-colors">Editar</button>
                        <button data-task-id="${task.id}" class="delete-btn text-gray-400 hover:text-red-600 transition-colors">Excluir</button>
                        <button data-task-id="${task.id}" class="complete-btn bg-gray-200 text-gray-700 font-semibold py-1 px-3 rounded-full text-sm transition-colors">Concluir</button>
                    </div>
                `;
                taskList.appendChild(card);
            });
        }
        
        // --- AUTENTICA√á√ÉO, FIRESTORE, E OUTRAS FUN√á√ïES PRINCIPAIS... ---
        
        function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => {
                console.error("Erro no login com Google:", error);
                alert("N√£o foi poss√≠vel fazer o login. Verifique se os pop-ups est√£o bloqueados.");
            });
        }

        function signInAnonymouslyUser() {
            signInAnonymously(auth).catch(error => {
                console.error("Erro no login an√≥nimo:", error);
                alert("N√£o foi poss√≠vel entrar como convidado.");
            });
        }

        function signOutUser() {
            signOut(auth).catch(error => {
                console.error("Erro ao sair:", error);
            });
        }

        function fetchData() {
            if (!currentUser) return;
            loadingSpinner.style.display = 'block';
            
            const catRef = collection(db, `users/${currentUser.uid}/categories`);
            const qCat = query(catRef, orderBy("order"));
            unsubscribeCategories = onSnapshot(qCat, async (snapshot) => {
                if (snapshot.empty) {
                    await createDefaultCategories();
                } else {
                    categories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                }
                
                const taskRef = collection(db, `users/${currentUser.uid}/tasks`);
                unsubscribeTasks = onSnapshot(taskRef, (taskSnapshot) => {
                    tasks = taskSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    loadingSpinner.style.display = 'none';
                    renderAll();
                });
            }, error => {
                console.error("Erro ao buscar categorias:", error);
                loadingSpinner.style.display = 'none';
            });
        }

        function stopDataListeners() {
            if (unsubscribeCategories) unsubscribeCategories();
            if (unsubscribeTasks) unsubscribeTasks();
        }

        async function saveTask(taskData) {
            if (!currentUser) return;
            try {
                if (taskData.id) {
                    const taskDocRef = doc(db, `users/${currentUser.uid}/tasks`, taskData.id);
                    const { id, ...dataToUpdate } = taskData;
                    await updateDoc(taskDocRef, dataToUpdate);
                } else {
                    const tasksRef = collection(db, `users/${currentUser.uid}/tasks`);
                    const { id, ...dataToAdd } = taskData;
                    await addDoc(tasksRef, dataToAdd);
                }
            } catch (error) { 
                console.error("Erro ao salvar tarefa: ", error);
                alert("Ocorreu um erro ao salvar a tarefa. Verifique a consola para mais detalhes (F12).");
            }
        }

        async function handleTaskFormSubmit(e) {
            e.preventDefault();
            const importance = parseInt(document.getElementById('task-importance').value, 10);
            const effort = parseInt(document.getElementById('task-effort').value, 10);
            const taskData = {
                id: document.getElementById('task-id').value || null,
                name: document.getElementById('task-name').value,
                details: document.getElementById('task-details').value,
                link: document.getElementById('task-link').value,
                category: document.getElementById('task-category').value,
                importance: importance,
                effort: effort,
                forca: (importance * 10) + effort,
                completed: false,
                dueDate: tempDueDate,
                repeatRule: tempRepeatRule,
                createdAt: serverTimestamp(),
                overdueResetDate: null
            };

            const existingTask = tasks.find(t => t.id === taskData.id);
            if(existingTask) {
                taskData.completed = existingTask.completed;
                taskData.createdAt = existingTask.createdAt;
            }

            await saveTask(taskData);
            closeModal('task-modal');
        }

        function openModal(modalId, data = null) {
            if (modalId === 'task-modal') {
                taskForm.reset();
                tempDueDate = data?.dueDate || null;
                tempRepeatRule = data?.repeatRule || { frequency: 'none' };

                document.getElementById('modal-title').textContent = data ? 'Editar Tarefa' : 'Nova Tarefa';
                document.getElementById('task-id').value = data?.id || '';
                document.getElementById('task-name').value = data?.name || '';
                document.getElementById('task-details').value = data?.details || '';
                document.getElementById('task-link').value = data?.link || '';
                document.getElementById('task-category').value = data?.category || (currentCategoryFilter === 'all' ? (categories[0]?.id || '') : currentCategoryFilter);
                document.getElementById('task-importance').value = data?.importance || '3';
                document.getElementById('task-effort').value = data?.effort || '3';
                taskDueDateInput.value = data?.dueDate || '';
            }
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }
        
        // --- INICIALIZA√á√ÉO E EVENT LISTENERS ---
        function init() {
            currentDateEl.textContent = getFormattedDate(new Date());
            setupEventListeners();
            onAuthStateChanged(auth, (user) => {
                stopDataListeners();
                clearUI();
                if (user) {
                    currentUser = user;
                    showAppUI(user);
                    fetchData();
                } else {
                    currentUser = null;
                    showLoginUI();
                }
            });
        }
        
        function setupEventListeners() {
            document.getElementById('login-btn').addEventListener('click', signInWithGoogle);
            document.getElementById('anonymous-login-btn').addEventListener('click', signInAnonymouslyUser);
            document.getElementById('logout-btn').addEventListener('click', signOutUser);
            document.getElementById('add-task-btn').addEventListener('click', () => openModal('task-modal'));
            taskForm.addEventListener('submit', handleTaskFormSubmit);
            document.getElementById('cancel-btn').addEventListener('click', () => closeModal('task-modal'));
            document.getElementById('close-modal-btn').addEventListener('click', () => closeModal('task-modal'));

            // Date buttons
            document.getElementById('date-btn-today').addEventListener('click', () => {
                const today = toYYYYMMDD(new Date());
                tempDueDate = today;
                taskDueDateInput.value = today;
            });
            document.getElementById('date-btn-tomorrow').addEventListener('click', () => {
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                const tomorrowStr = toYYYYMMDD(tomorrow);
                tempDueDate = tomorrowStr;
                taskDueDateInput.value = tomorrowStr;
            });
            taskDueDateInput.addEventListener('change', (e) => {
                tempDueDate = e.target.value;
            });

            // Repeat modal
            document.getElementById('repeat-btn').addEventListener('click', () => {
                document.getElementById('repeat-frequency').value = tempRepeatRule.frequency || 'none';
                openModal('repeat-modal');
            });
            document.getElementById('cancel-repeat-btn').addEventListener('click', () => closeModal('repeat-modal'));
            document.getElementById('save-repeat-btn').addEventListener('click', () => {
                tempRepeatRule.frequency = document.getElementById('repeat-frequency').value;
                closeModal('repeat-modal');
            });

            // Task list dynamic buttons
            taskList.addEventListener('click', async e => {
                const button = e.target.closest('button');
                if (!button) return;

                const taskId = button.dataset.taskId;
                if (!taskId) return;
                const task = tasks.find(t => t.id === taskId);
                if (!task) return;

                if (button.classList.contains('complete-btn')) {
                    if (task.repeatRule && task.repeatRule.frequency !== 'none') {
                        const newDueDate = new Date(task.dueDate + 'T12:00:00Z'); // Use UTC to avoid timezone shifts
                        switch(task.repeatRule.frequency) {
                            case 'daily': newDueDate.setDate(newDueDate.getDate() + 1); break;
                            case 'weekly': newDueDate.setDate(newDueDate.getDate() + 7); break;
                            case 'monthly': newDueDate.setMonth(newDueDate.getMonth() + 1); break;
                            case 'yearly': newDueDate.setFullYear(newDueDate.getFullYear() + 1); break;
                        }
                        await updateDoc(doc(db, `users/${currentUser.uid}/tasks`, taskId), {
                            dueDate: toYYYYMMDD(newDueDate),
                            overdueResetDate: null
                        });
                    } else {
                        await updateDoc(doc(db, `users/${currentUser.uid}/tasks`, taskId), { completed: true });
                    }
                } else if (button.classList.contains('edit-btn')) {
                    openModal('task-modal', task);
                } else if (button.classList.contains('delete-btn')) {
                    if (confirm("Tem certeza que deseja excluir esta tarefa?")) {
                        await deleteDoc(doc(db, `users/${currentUser.uid}/tasks`, taskId));
                    }
                } else if (button.classList.contains('reset-overdue-btn')) {
                    await updateDoc(doc(db, `users/${currentUser.uid}/tasks`, taskId), { overdueResetDate: toYYYYMMDD(new Date()) });
                }
            });
            
            // ... (restante dos listeners, como manage-areas, backup, etc.)
        }

        // --- Fun√ß√µes de UI restantes ---
        function showLoginUI() {
            loginContainer.style.display = 'flex';
            appContainer.style.display = 'none';
        }

        function showAppUI(user) {
            loginContainer.style.display = 'none';
            appContainer.style.display = 'flex';
            if (user.isAnonymous) {
                userPhoto.src = 'https://placehold.co/40x40/E2E8F0/A0AEC0?text=C';
                userName.textContent = 'Utilizador Convidado';
            } else {
                userPhoto.src = user.photoURL || 'https://placehold.co/40x40/E2E8F0/A0AEC0?text=U';
                userName.textContent = user.displayName || 'Utilizador';
            }
        }
        
        function clearUI() {
            taskList.innerHTML = '';
            categoryList.innerHTML = '';
            categories = [];
            tasks = [];
        }

        function populateCategorySelect() {
            taskCategorySelect.innerHTML = '';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.textContent = `${cat.emoji} ${cat.name}`;
                taskCategorySelect.appendChild(option);
            });
        }

        function renderCategories() {
            categoryList.innerHTML = '';
            const allTasksButton = document.createElement('button');
            allTasksButton.className = `w-full text-left px-3 py-2 rounded-md font-medium flex items-center space-x-3 transition-colors ${currentCategoryFilter === 'all' ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100'}`;
            allTasksButton.innerHTML = `<span>üìã</span><span>Todas as Tarefas</span>`;
            allTasksButton.addEventListener('click', () => {
                currentCategoryFilter = 'all';
                mainTitle.textContent = 'Todas as Tarefas';
                renderAll();
            });
            categoryList.appendChild(allTasksButton);

            categories.forEach(cat => {
                const catElement = document.createElement('button');
                catElement.className = `w-full text-left px-3 py-2 rounded-md font-medium flex items-center space-x-3 transition-colors ${currentCategoryFilter === cat.id ? 'bg-blue-100 text-blue-700' : 'hover:bg-gray-100'}`;
                catElement.dataset.categoryId = cat.id;
                catElement.innerHTML = `<span>${cat.emoji}</span><span>${cat.name}</span>`;
                catElement.addEventListener('click', () => {
                    currentCategoryFilter = cat.id;
                    mainTitle.textContent = cat.name;
                    renderAll();
                });
                categoryList.appendChild(catElement);
            });
        }
        
        async function createDefaultCategories() {
            const batch = writeBatch(db);
            const defaultCategories = [
                { name: 'Sa√∫de F√≠sica', emoji: 'üèãüèª‚Äç‚ôÇÔ∏è', order: 0 }, { name: 'Sa√∫de Mental', emoji: 'üßòüèª‚Äç‚ôÇÔ∏è', order: 1 },
                { name: 'Cachorra', emoji: 'ü¶Å', order: 2 }, { name: 'Pais', emoji: 'üë©üèªüë®üèª', order: 3 },
                { name: 'Irm√£', emoji: 'üë©üèº‚Äçü¶±', order: 4 }, { name: 'V√≥', emoji: 'üëµüèª', order: 5 },
                { name: 'Loja', emoji: 'üè™', order: 6 }, { name: 'S√≠tio', emoji: 'üè°', order: 7 },
                { name: 'Casa', emoji: 'üè†', order: 8 }, { name: 'Cursos e Estudos', emoji: 'üë®üèª‚Äçüè´', order: 9 },
                { name: 'Contribui√ß√£o/Legado', emoji: 'üåé', order: 10 }, { name: 'Relacionamento Amoroso', emoji: '‚ù§Ô∏è', order: 11 },
                { name: 'Networking/Amizades', emoji: 'ü§ù', order: 12 }, { name: 'Renda/Neg√≥cios/Trabalho', emoji: 'üíµ', order: 13 },
                { name: 'Ambiente', emoji: 'üóÑÔ∏è', order: 14 }, { name: 'Lazer/Tempo Livre/Hobbies', emoji: 'üéÆ', order: 15 },
                { name: 'Espiritualidade', emoji: '‚ú°Ô∏è', order: 16 },
            ];
            defaultCategories.forEach(cat => {
                const catRef = doc(collection(db, `users/${currentUser.uid}/categories`));
                batch.set(catRef, cat);
            });
            await batch.commit();
        }
        
        // ... (restante do c√≥digo para gerir √°reas, backup, etc.)
        
        init();
    </script>
</body>
</html>
ÔøΩ
